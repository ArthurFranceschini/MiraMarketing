---
import { Shield, Search, Target, Handshake, Palette, Instagram, TrafficCone, CodeXml, BrainCircuit, Funnel, Rocket, Maximize2, Clapperboard } from '@lucide/astro';
import ServiceCard from './ServiceCard.astro';

interface Props {
  lang: 'pt' | 'es';
}

const { lang } = Astro.props;

import ptServices from '../i18n/pt/services.json';
import esServices from '../i18n/es/services.json';

const t = lang === 'pt' ? ptServices : esServices;

const services = [
  { icon: Shield, ...t.services.branding },
  { icon: Search, ...t.services.seo },
  { icon: Target, ...t.services.planning },
  { icon: Handshake, ...t.services.consulting },
  { icon: Palette, ...t.services.design },
  { icon: Instagram, ...t.services.social },
  { icon: TrafficCone, ...t.services.traffic },
  { icon: CodeXml, ...t.services.dev },
  { icon: BrainCircuit, ...t.services.automation },
  { icon: Funnel, ...t.services.crm },
  { icon: Rocket, ...t.services.launches },
  { icon: Maximize2, ...t.services.licensing },
  { icon: Clapperboard, ...t.services.audiovisual },
];

const schemaData = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": t.title,
  "description": t.subtitle,
  "numberOfItems": services.length,
  "itemListElement": services.map((service, index) => ({
    "@type": "ListItem",
    "position": index + 1,
    "item": {
      "@type": "Service",
      "name": service.title,
      "description": service.description,
      "url": `https://miramarketing.com/${lang}/${service.href}`,
      "provider": {
        "@type": "Organization",
        "name": "Mira Marketing"
      }
    }
  }))
};
---

<section 
  id="servicos" 
  class="px-8 py-16 md:px-32 md:py-32" 
  aria-labelledby="services-heading"
  itemscope
  itemtype="https://schema.org/ItemList"
>

  <svg class="absolute w-0 h-0" aria-hidden="true">
    <defs>
      <linearGradient id="service-icon-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" stop-color="#0004FF" />
        <stop offset="100%" stop-color="#FF0A0A" />
      </linearGradient>
    </defs>
  </svg>
  
  <div class="text-center mb-8 md:mb-16">
    <h2 
      id="services-heading" 
      class="text-2xl md:text-5xl font-bold tracking-tight fade-in"
      itemprop="name"
    >
      <span class="bg-linear-to-r from-[#0004FF] to-[#FF0A0A] bg-clip-text text-transparent">{t.title}</span>
    </h2>
    
    <p class="text-sm md:text-2xl font-bold mt-4 md:mt-8 fade-in" itemprop="description">{t.subtitle}</p>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
    {services.map((service, index) => (
      <article class="service-wrapper fade-in" data-index={index} itemprop="itemListElement" itemscope itemtype="https://schema.org/Service">
        <ServiceCard
          icon={service.icon}
          title={service.title}
          serviceName={service.name}
          description={service.description}
          href={service.href}
        />
      </article>
    ))}
  </div>

</section>

<script type="application/ld+json" set:html={JSON.stringify(schemaData)} />

<style>
  .fade-in {
    opacity: 0;
    transform: translateY(2rem);
    transition: opacity 0.6s ease-out, transform 0.6s ease-out;
  }

  .fade-in.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .service-wrapper {
    transition: transform 0.3s ease-out, opacity 0.3s ease-out;
  }
</style>

<script>
  const fadeObserver = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const index = parseInt((entry.target as HTMLElement).dataset.index || '0');
          setTimeout(() => {
            entry.target.classList.add('visible');
          }, index * 100);
        }
      });
    },
    { threshold: 0.1 }
  );

  document.querySelectorAll('#servicos .fade-in').forEach((el) => {
    fadeObserver.observe(el);
  });

  const cards = document.querySelectorAll('.service-wrapper');
  
  function handleScroll() {
    cards.forEach((card) => {
      const rect = card.getBoundingClientRect();
      const windowHeight = window.innerHeight;
      const cardCenter = rect.top + rect.height / 2;
      const viewportCenter = windowHeight / 2;
      const distance = Math.abs(cardCenter - viewportCenter);
      const maxDistance = windowHeight;
      
      const scale = 1 - (distance / maxDistance) * 0.1;
      const clampedScale = Math.max(0.9, Math.min(1, scale));
      
      (card as HTMLElement).style.transform = `scale(${clampedScale})`;
    });
  }

  window.addEventListener('scroll', handleScroll, { passive: true });
  handleScroll();
</script>